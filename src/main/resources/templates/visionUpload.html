<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/defaultLayout}">
<head>
    <title>ë™ë¬¼ ì´ë¯¸ì§€ ë¶„ì„</title>
    <th:block layout:fragment="css">
        <!-- Bootstrap CSS (í•„ìš”ì‹œ) -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

        <style>
            /* ì „ì²´ í°íŠ¸ ì„¤ì • */
            * {
                font-family: 'HakgyoansimDunggeunmisoTTF-B', BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            }

            /* body ë°°ê²½ìƒ‰ì„ ë‘ ë²ˆì§¸ ì´ë¯¸ì§€ì™€ ë™ì¼í•˜ê²Œ ì„¤ì • */
            body {
                background-color: var(--background-color, #f8f9fa);
            }

            /* í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
            .vision-container {
                max-width: 600px;
                margin: 0 auto;
            }

            .card {
                margin-top: 2rem;
                border-radius: var(--border-radius-lg, 12px);
                box-shadow: var(--box-shadow-light, 0 4px 6px rgba(0, 0, 0, 0.1));
                border: none;
            }

            .card-body {
                padding: 2rem;
            }

            #imagePreview img {
                max-height: 200px;
                object-fit: contain;
            }

            .spinner-border {
                width: 3rem;
                height: 3rem;
                color: var(--accent-color, #ff6b6b) !important;
            }

            #spinnerContainer {
                background-color: var(--card-bg-color, #ffffff);
                padding: 2rem;
                border-radius: var(--border-radius-lg, 12px);
                box-shadow: var(--box-shadow-light, 0 4px 6px rgba(0, 0, 0, 0.1));
            }

            #result {
                background-color: var(--card-bg-color, #ffffff);
                padding: 2rem;
                border-radius: var(--border-radius-lg, 12px);
                box-shadow: var(--box-shadow-light, 0 4px 6px rgba(0, 0, 0, 0.1));
                margin-top: 2rem;
            }

            pre#finalReport {
                background: var(--background-color, #f8f9fa);
                padding: 1.5rem;
                border-radius: var(--border-radius-sm, 8px);
                white-space: pre-wrap;
                word-wrap: break-word;
                max-height: 500px;
                overflow-y: auto;
                border: 1px solid #e9ecef;
                font-family: 'Noto Sans KR', monospace;
            }

            .alert {
                border-radius: var(--border-radius-sm, 8px);
            }

            .btn-primary {
                background-color: var(--accent-color, #ff6b6b);
                border-color: var(--accent-color, #ff6b6b);
                border-radius: 30px;
                padding: 0.75rem 2rem;
                font-weight: 500;
                transition: all 0.3s ease;
            }

            .btn-primary:hover {
                background-color: var(--button-hover-color, #ff5252);
                border-color: var(--button-hover-color, #ff5252);
                transform: translateY(-2px);
            }

            .form-label {
                color: var(--secondary-text-color, #6c757d);
                font-weight: 500;
                margin-bottom: 0.5rem;
            }

            .form-control {
                border-radius: var(--border-radius-sm, 8px);
                border: 2px solid #e9ecef;
                transition: border-color 0.3s ease;
            }

            .form-control:focus {
                border-color: var(--accent-color, #ff6b6b);
                box-shadow: 0 0 0 0.2rem rgba(255, 107, 107, 0.25);
            }

            /* ì¤‘ê°„ ë³´ê³ ì„œ ìŠ¤íƒ€ì¼ ê°œì„  */
            #interim {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 1.5rem;
                border-radius: var(--border-radius-lg, 12px);
                margin-bottom: 1rem;
                text-align: center;
                font-weight: 500;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                transition: all 0.3s ease;
            }

            #interim.hidden {
                opacity: 0;
                transform: translateY(-20px);
                pointer-events: none;
            }

            #analyzingMessage {
                font-style: italic;
                color: var(--secondary-text-color, #6c757d);
                text-align: center;
                margin: 1rem 0;
                font-size: 0.9rem;
            }

            /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ê°œì„  */
            .loading-pulse {
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0% { opacity: 1; }
                50% { opacity: 0.5; }
                100% { opacity: 1; }
            }

            /* ì„±ê³µ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
            .success-message {
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                color: white;
                padding: 1rem;
                border-radius: var(--border-radius-lg, 12px);
                text-align: center;
                margin: 1rem 0;
                font-weight: 500;
            }
        </style>
    </th:block>
</head>
<body>
<th:block layout:fragment="content">
    <main>
        <div class="vision-container">
            <!-- ì˜¤í”„ë¼ì¸ ì•Œë¦¼ -->
            <div id="offlineAlert" class="alert alert-warning" style="display: none;">
                <i class="bi bi-wifi-off"></i> ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
            </div>

            <!-- ë©”ì¸ í¼ ì¹´ë“œ -->
            <div class="card">
                <div class="card-body" id="formContainer">
                    <h3 class="text-center mb-4">ğŸ¾ ë°˜ë ¤ë™ë¬¼ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</h3>
                    <form id="visionForm">
                        <div class="mb-3">
                            <label for="petName" class="form-label">ë°˜ë ¤ë™ë¬¼ ì´ë¦„</label>
                            <input type="text" class="form-control" name="petName" id="petName"
                                   placeholder="ë°˜ë ¤ë™ë¬¼ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required />
                        </div>
                        <div class="mb-3">
                            <label for="file" class="form-label">ì´ë¯¸ì§€ ì„ íƒ</label>
                            <input type="file" class="form-control" name="file" id="file"
                                   accept="image/jpeg,image/jpg,image/png" required />
                            <small class="text-muted">âš ï¸ JPEG, PNG í˜•ì‹ë§Œ ì§€ì›í•©ë‹ˆë‹¤ (ìµœëŒ€ 5MB)</small>
                        </div>
                        <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
                        <div id="imagePreview" class="mb-3 text-center" style="display: none;">
                            <img id="previewImg" src="" alt="ë¯¸ë¦¬ë³´ê¸°" class="img-fluid rounded" />
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary" id="submitBtn">ë¶„ì„í•˜ê¸°</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
            <div id="spinnerContainer" class="text-center mt-3" style="display: none">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 loading-pulse">ğŸ”„ ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...</p>
            </div>

            <!-- ê²°ê³¼ í‘œì‹œ -->
            <div id="result" style="display: none">
                <div class="mb-3 text-center">
                    <img id="showImg" src="" alt="ë¶„ì„ëœ ì´ë¯¸ì§€" class="img-fluid rounded shadow"
                         style="max-width: 100%" />
                </div>

                <!-- ì¤‘ê°„ ë³´ê³ ì„œ -->
                <div id="interim" class="fw-bold" style="display: none;"></div>

                <!-- ë¶„ì„ ì¤‘ ë©”ì‹œì§€ -->
                <div id="analyzingMessage" style="display: none;">
                    <small>ğŸ“ ìƒì„¸í•œ ë³´ê³ ì„œë¥¼ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤...</small>
                </div>

                <!-- ìµœì¢… ë³´ê³ ì„œ -->
                <pre id="finalReport" style="display: none;"></pre>

                <!-- ì„±ê³µ ë©”ì‹œì§€ -->
                <div id="successMessage" class="success-message" style="display: none;">
                    âœ¨ ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë³´ê³ ì„œ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...
                </div>

                <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
                <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

                <!-- ëŒì•„ê°€ê¸° ë²„íŠ¼ -->
                <div class="text-center mt-4">
                    <a href="/" class="btn btn-outline-secondary">â¬… ëŒì•„ê°€ê¸°</a>
                </div>
            </div>
        </div>
    </main>
</th:block>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        const form = document.getElementById('visionForm');
        const spinner = document.getElementById('spinnerContainer');
        const result = document.getElementById('result');
        const interim = document.getElementById('interim');
        const analyzingMessage = document.getElementById('analyzingMessage');
        const report = document.getElementById('finalReport');
        const successMessage = document.getElementById('successMessage');
        const showImg = document.getElementById('showImg');
        const fileInput = document.getElementById('file');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const errorMessage = document.getElementById('errorMessage');
        const offlineAlert = document.getElementById('offlineAlert');

        // ì˜¤í”„ë¼ì¸ ìƒíƒœ ê°ì§€
        function updateOnlineStatus() {
            offlineAlert.style.display = navigator.onLine ? 'none' : 'block';
        }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();

        // íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸° ë° ê²€ì¦
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) {
                imagePreview.style.display = 'none';
                return;
            }

            // íŒŒì¼ í˜•ì‹ ê²€ì¦
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
            if (!validTypes.includes(file.type)) {
                alert('AWS Rekognitionì€ JPEG, PNG í˜•ì‹ë§Œ ì§€ì›í•©ë‹ˆë‹¤.');
                fileInput.value = '';
                imagePreview.style.display = 'none';
                return;
            }

            // íŒŒì¼ í¬ê¸° ê²€ì¦ (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                fileInput.value = '';
                imagePreview.style.display = 'none';
                return;
            }

            // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        });

        // ì¸ì¦ëœ fetch í•¨ìˆ˜
        async function authenticatedFetch(url, options = {}) {
            try {
                let response = await fetch(url, {
                    ...options,
                    credentials: 'include'
                });

                if (response.status !== 401) {
                    return response;
                }

                // 401 ì‘ë‹µ ì‹œ í† í° ê°±ì‹  ì‹œë„
                console.log('í† í° ê°±ì‹  ì‹œë„...');
                const refreshResponse = await fetch('/api/auth/refresh', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (!refreshResponse.ok) {
                    window.location.href = '/login';
                    throw new Error('ì„¸ì…˜ ë§Œë£Œ');
                }

                // ì›ë˜ ìš”ì²­ ì¬ì‹œë„
                return await fetch(url, {
                    ...options,
                    credentials: 'include'
                });

            } catch (error) {
                console.error('ì¸ì¦ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                throw error;
            }
        }

        form.addEventListener('submit', async e => {
            e.preventDefault();

            // ì˜¤í”„ë¼ì¸ ì²´í¬
            if (!navigator.onLine) {
                alert('ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }

            // UI ì´ˆê¸°í™”
            form.parentElement.parentElement.style.display = 'none';
            spinner.style.display = 'block';
            result.style.display = 'none';
            errorMessage.style.display = 'none';
            interim.style.display = 'none';
            interim.classList.remove('hidden');
            report.style.display = 'none';
            analyzingMessage.style.display = 'none';
            successMessage.style.display = 'none';

            const fd = new FormData(form);
            const petName = document.getElementById('petName').value;

            if (fileInput.files[0]) {
                showImg.src = URL.createObjectURL(fileInput.files[0]);
            }

            try {
                // ì²« ë²ˆì§¸ ë¶„ì„ (AWS Rekognition)
                const res1 = await authenticatedFetch('/vision/species', {
                    method: 'POST',
                    body: fd
                });

                if (!res1.ok) {
                    throw new Error('ì¢… ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                const text1 = await res1.text();
                interim.textContent = `ğŸ” '${petName}'ì€(ëŠ”) '${text1}' !`;
                interim.style.display = 'block';
                result.style.display = 'block';
                spinner.style.display = 'none';
                analyzingMessage.style.display = 'block';

            } catch (e) {
                errorMessage.textContent = 'AWS ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message;
                errorMessage.style.display = 'block';
                result.style.display = 'block';
                spinner.style.display = 'none';
                console.error(e);
                return;
            }

            try {
                // ë‘ ë²ˆì§¸ ë¶„ì„ (OpenAI) - ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰
                const res2 = await authenticatedFetch('/vision/analyze', {
                    method: 'POST',
                    body: fd
                });

                if (!res2.ok) {
                    throw new Error('ìµœì¢… ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                await res2.text(); // ê²°ê³¼ë¥¼ ë°›ì•„ì„œ ì„¸ì…˜ì— ì €ì¥ë˜ë„ë¡ í•˜ì§€ë§Œ í‘œì‹œí•˜ì§€ ì•ŠìŒ

                // ì¤‘ê°„ ë³´ê³ ì„œë¥¼ ë¶€ë“œëŸ½ê²Œ ìˆ¨ê¸°ê¸°
                interim.classList.add('hidden');
                analyzingMessage.style.display = 'none';

                // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ í›„ ë°”ë¡œ í˜ì´ì§€ ì´ë™
                successMessage.style.display = 'block';
                setTimeout(() => {
                    // ë§ˆí¬ë‹¤ìš´ í‘œì‹œ ì—†ì´ ë°”ë¡œ ë³´ê³ ì„œ í˜ì´ì§€ë¡œ ì´ë™
                    window.location.href = '/flow/showVisionReport';
                }, 1000);

            } catch (e) {
                analyzingMessage.style.display = 'none';
                interim.classList.add('hidden');
                setTimeout(() => {
                    interim.style.display = 'none';
                }, 300);

                errorMessage.textContent = 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message;
                errorMessage.style.display = 'block';
                console.error(e);
            }
        });
    </script>
</th:block>
</body>
</html>