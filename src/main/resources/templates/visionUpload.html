<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/defaultLayout}">
<head>
    <title>ë™ë¬¼ ì´ë¯¸ì§€ ë¶„ì„</title>
    <th:block layout:fragment="css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"/>
        <link rel="stylesheet" th:href="@{/css/bootstrap-overrides.css}"/>
        <style>
            /* xxl í™”ë©´(1400px) ì´ìƒì—ì„œë§Œ ìµœëŒ€ ë„ˆë¹„ë¥¼ 1296pxë¡œ ì„¤ì •í•˜ì—¬ search í˜ì´ì§€ì™€ ë™ì¼í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤. */
            @media (min-width: 1400px) {
                .vision-container-custom {
                    max-width: 1296px;
                }
            }

            /* ì‚¬ìš©ëŸ‰ ì •ë³´ ë°•ìŠ¤ì˜ ê³ ìœ í•œ ê·¸ë¼ë°ì´ì…˜ ë””ìì¸ì€ ìœ ì§€í•©ë‹ˆë‹¤. */
            .alert-info {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                border-radius: var(--border-radius-lg);
            }
            .alert-warning {
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                color: white;
                border: none;
                border-radius: var(--border-radius-lg);
            }

            /* ê¸°íƒ€ ì´ í˜ì´ì§€ì—ì„œë§Œ í•„ìš”í•œ ìŠ¤íƒ€ì¼ */
            #imagePreview img {
                max-height: 200px;
                object-fit: contain;
            }
            .loading-pulse {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0% { opacity: 1; }
                50% { opacity: 0.5; }
                100% { opacity: 1; }
            }
        </style>
    </th:block>
</head>
<body>
<th:block layout:fragment="content">

    <div class="container vision-container-custom mt-4">
        <div class="p-md-3 p-2 bg-white rounded shadow-sm">
            <div class="row justify-content-center">
                <div class="col-lg-8">

                    <div th:if="${username}" class="alert alert-info text-center mb-4">
                        <strong>ğŸ‰ ì•ˆë…•í•˜ì„¸ìš”, <span th:text="${username}"></span>ë‹˜!</strong><br>
                        <span th:if="${canUse}">
                            ì˜¤ëŠ˜ <strong th:text="${remainingUsage}"></strong>íšŒ ë” ë¶„ì„í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            (ì´ <span th:text="${dailyLimit}"></span>íšŒ ì¤‘ <span th:text="${dailyLimit - remainingUsage}"></span>íšŒ ì‚¬ìš©ë¨)
                        </span>
                        <span th:unless="${canUse}" class="text-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            ì˜¤ëŠ˜ì˜ ë¶„ì„ í•œë„(<span th:text="${dailyLimit}"></span>íšŒ)ë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ì…¨ìŠµë‹ˆë‹¤.<br>
                            ë‚´ì¼ ë‹¤ì‹œ ì´ìš©í•´ì£¼ì„¸ìš”! ğŸ¾
                        </span>
                    </div>

                    <div th:unless="${username}" class="alert alert-warning text-center mb-4">
                        <i class="bi bi-lock"></i>
                        <strong>Vision ë¶„ì„ ê¸°ëŠ¥ì„ ì´ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</strong><br>
                        <a href="/login" class="btn btn-primary btn-sm mt-2">ë¡œê·¸ì¸í•˜ê¸°</a>
                    </div>

                    <h3 class="text-center mb-4">ğŸ¾ ë°˜ë ¤ë™ë¬¼ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</h3>

                    <form id="visionForm" th:classappend="${!canUse} ? 'disabled' : ''">
                        <div class="mb-3">
                            <label for="petName" class="form-label">ë°˜ë ¤ë™ë¬¼ ì´ë¦„</label>
                            <input type="text" class="form-control" name="petName" id="petName"
                                   placeholder="ë°˜ë ¤ë™ë¬¼ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                                   th:disabled="${!canUse}" required/>
                        </div>
                        <div class="mb-3">
                            <label for="file" class="form-label">ì´ë¯¸ì§€ ì„ íƒ</label>
                            <input type="file" class="form-control" name="file" id="file"
                                   accept="image/jpeg,image/jpg,image/png"
                                   th:disabled="${!canUse}" required/>
                            <small class="text-muted">âš ï¸ JPEG, PNG í˜•ì‹ë§Œ ì§€ì›í•©ë‹ˆë‹¤ (ìµœëŒ€ 5MB)</small>
                        </div>
                        <div id="imagePreview" class="mb-3 text-center" style="display: none;">
                            <img id="previewImg" src="" alt="ë¯¸ë¦¬ë³´ê¸°" class="img-fluid rounded"/>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary" id="submitBtn"
                                    th:disabled="${!canUse}">
                                <span th:if="${canUse}">ë¶„ì„í•˜ê¸°</span>
                                <span th:unless="${canUse}">ì‚¬ìš©ëŸ‰ ì´ˆê³¼</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="result" class="mt-4" style="display: none">
            <div class="p-md-3 p-2 bg-white rounded shadow-sm">
                <div class="mb-3 text-center">
                    <img id="showImg" src="" alt="ë¶„ì„ëœ ì´ë¯¸ì§€" class="img-fluid rounded shadow" style="max-width: 100%"/>
                </div>
                <div id="interim" class="fw-bold alert alert-secondary" style="display: none;"></div>
                <div id="analyzingMessage" style="display: none;">
                    <small>ğŸ“ ìƒì„¸í•œ ë³´ê³ ì„œë¥¼ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤...</small>
                </div>
                <pre id="finalReport" style="display: none;"></pre>
                <div id="successMessage" class="alert alert-success" style="display: none;">
                    âœ¨ ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë³´ê³ ì„œ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...
                </div>
                <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>
                <div class="text-center mt-4">
                    <a href="/" class="btn btn-outline-secondary">â¬… ëŒì•„ê°€ê¸°</a>
                </div>
            </div>
        </div>
    </div>
</th:block>

<th:block layout:fragment="script">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script th:inline="javascript">
        const form = document.getElementById('visionForm');
        const spinner = document.getElementById('spinnerContainer');
        const result = document.getElementById('result');
        const interim = document.getElementById('interim');
        const analyzingMessage = document.getElementById('analyzingMessage');
        const report = document.getElementById('finalReport');
        const successMessage = document.getElementById('successMessage');
        const showImg = document.getElementById('showImg');
        const fileInput = document.getElementById('file');
        const imagePreview = document.getElementById('imagePreview');
        const errorMessage = document.getElementById('errorMessage');
        const isLoggedIn = /*[[${username != null} ? 'true' : 'false']]*/ 'false';
        const canUse = /*[[${canUse} ? 'true' : 'false']]*/ 'false';

        form.addEventListener('submit', async e => {
            e.preventDefault();

            // ë¡œê·¸ì¸ ì²´í¬
            if (isLoggedIn !== 'true') {
                if (confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    window.location.href = '/login';
                }
                return;
            }

            // ì‚¬ìš©ëŸ‰ ì²´í¬
            if (!canUse) {
                alert('ì˜¤ëŠ˜ì˜ ë¶„ì„ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ë‚´ì¼ ë‹¤ì‹œ ì´ìš©í•´ì£¼ì„¸ìš”!');
                return;
            }

            // ì˜¤í”„ë¼ì¸ ì²´í¬
            if (!navigator.onLine) {
                alert('ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }

            // UI ì´ˆê¸°í™”
            form.parentElement.parentElement.style.display = 'none';
            spinner.style.display = 'block';
            result.style.display = 'none';
            errorMessage.style.display = 'none';
            interim.style.display = 'none';
            interim.classList.remove('hidden');
            report.style.display = 'none';
            analyzingMessage.style.display = 'none';
            successMessage.style.display = 'none';

            const fd = new FormData(form);
            const petName = document.getElementById('petName').value;

            if (fileInput.files[0]) {
                showImg.src = URL.createObjectURL(fileInput.files[0]);
            }

            try {
                // ì²« ë²ˆì§¸ ë¶„ì„ (AWS Rekognition)
                const res1 = await authenticatedFetch('/vision/species', {
                    method: 'POST',
                    body: fd
                });

                if (!res1.ok) {
                    if (res1.status === 401) {
                        alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                        window.location.href = '/login';
                        return;
                    }
                    throw new Error('ì¢… ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                const text1 = await res1.text();
                interim.textContent = `ğŸ” '${petName}'ì€(ëŠ”) '${text1}' !`;
                interim.style.display = 'block';
                result.style.display = 'block';
                spinner.style.display = 'none';
                analyzingMessage.style.display = 'block';

            } catch (e) {
                errorMessage.textContent = 'AWS ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message;
                errorMessage.style.display = 'block';
                result.style.display = 'block';
                spinner.style.display = 'none';
                console.error(e);
                return;
            }

            try {
                // ë‘ ë²ˆì§¸ ë¶„ì„ (Vision)
                const res2 = await authenticatedFetch('/vision/analyze', {
                    method: 'POST',
                    body: fd
                });

                if (!res2.ok) {
                    if (res2.status === 401) {
                        alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                        window.location.href = '/login';
                        return;
                    } else if (res2.status === 429) {
                        const errorText = await res2.text();
                        alert(errorText);
                        // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ì‚¬ìš©ëŸ‰ ì •ë³´ ì—…ë°ì´íŠ¸
                        window.location.reload();
                        return;
                    }
                    throw new Error('ìµœì¢… ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                await res2.text(); // ê²°ê³¼ë¥¼ ë°›ì•„ì„œ ì„¸ì…˜ì— ì €ì¥ë˜ë„ë¡ í•˜ì§€ë§Œ í‘œì‹œí•˜ì§€ ì•ŠìŒ

                // ì¤‘ê°„ ë³´ê³ ì„œë¥¼ ë¶€ë“œëŸ½ê²Œ ìˆ¨ê¸°ê¸°
                interim.classList.add('hidden');
                analyzingMessage.style.display = 'none';

                // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ í›„ ë°”ë¡œ í˜ì´ì§€ ì´ë™
                successMessage.style.display = 'block';
                setTimeout(() => {
                    // ë§ˆí¬ë‹¤ìš´ í‘œì‹œ ì—†ì´ ë°”ë¡œ ë³´ê³ ì„œ í˜ì´ì§€ë¡œ ì´ë™
                    window.location.href = '/flow/showVisionReport';
                }, 1000);

            } catch (e) {
                analyzingMessage.style.display = 'none';
                interim.classList.add('hidden');
                setTimeout(() => {
                    interim.style.display = 'none';
                }, 300);

                errorMessage.textContent = 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message;
                errorMessage.style.display = 'block';
                console.error(e);
            }

            function authenticatedFetch(url, options) {
                // í•­ìƒ ì¿ í‚¤(JWT í¬í•¨)ë„ í•¨ê»˜ ë³´ëƒ„
                return fetch(url, {
                    ...options,
                    credentials: 'include'
                });
            }
        });
    </script>
</th:block>
</body>
</html>