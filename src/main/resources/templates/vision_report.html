<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/defaultLayout}">
<head>
    <title>PETTY - ë°˜ë ¤ë™ë¬¼ ë³´ê³ ì„œ</title> <th:block layout:fragment="css">
    <style>
        /* ì´ë¯¸ì§€ ë° ì´ë¦„ í‘œì‹œë¥¼ ìœ„í•œ ìŠ¤íƒ€ì¼ */
        .pet-info-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
            background-color: var(--card-bg-color);
            padding: 20px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--box-shadow-light);
        }
        .pet-info-header img {
            width: 150px; /* ì ì ˆí•œ í¬ê¸°ë¡œ ì¡°ì ˆ */
            height: 150px; /* ì ì ˆí•œ í¬ê¸°ë¡œ ì¡°ì ˆ */
            border-radius: 50%; /* ì›í˜• ì´ë¯¸ì§€ */
            object-fit: cover; /* ì´ë¯¸ì§€ ë¹„ìœ¨ ìœ ì§€ */
            border: 4px solid var(--accent-color); /* í…Œë‘ë¦¬ ì¶”ê°€ */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }
        .pet-info-header h2 {
            font-size: 2em;
            color: var(--accent-color);
            margin-top: 0;
            margin-bottom: 5px;
        }
        .pet-info-header p {
            font-size: 1.2em;
            color: var(--secondary-text-color);
            margin: 0;
        }

        /* Marked.jsê°€ ìƒì„±í•˜ëŠ” HTML ìš”ì†Œì— ì ìš©ë  ìŠ¤íƒ€ì¼ */
        .report-content-display h1, .report-content-display h2, .report-content-display h3, .report-content-display h4, .report-content-display h5, .report-content-display h6 {
            color: #343a40; /* ì–´ë‘ìš´ í—¤ë”© ìƒ‰ìƒ */
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }
        .report-content-display p {
            color: #495057; /* ë³¸ë¬¸ í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
            margin-bottom: 1em;
        }
        .report-content-display a {
            color: #007bff; /* ë§í¬ ìƒ‰ìƒ */
            text-decoration: none;
        }
        .report-content-display a:hover {
            text-decoration: underline;
        }
        .report-content-display pre {
            background-color: #272822; /* ì½”ë“œ ë¸”ë¡ ë°°ê²½ (Prism.js í…Œë§ˆì™€ ì–´ìš¸ë¦¬ê²Œ) */
            color: #f8f8f2; /* ì½”ë“œ ë¸”ë¡ í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto; /* ë‚´ìš©ì´ ê¸¸ë©´ ê°€ë¡œ ìŠ¤í¬ë¡¤ë°” */
            font-size: 0.9em;
            margin-bottom: 1em;
        }
        .report-content-display code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace; /* ì½”ë“œ í°íŠ¸ */
        }
        .report-content-display table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
        }
        .report-content-display th, .report-content-display td {
            border: 1px solid #dee2e6; /* í…Œì´ë¸” ì„  */
            padding: 8px;
            text-align: left;
        }
        .report-content-display th {
            background-color: #e9ecef; /* í…Œì´ë¸” í—¤ë” ë°°ê²½ */
            color: #495057;
        }
        .report-content-display ul, .report-content-display ol {
            margin-left: 20px;
            margin-bottom: 1em;
        }
        .report-content-display blockquote {
            border-left: 4px solid #ced4da; /* ì¸ìš©êµ¬ ì™¼ìª½ ì„  */
            padding-left: 15px;
            color: #6c757d;
            margin: 1em 0;
        }
    </style>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
</th:block>
</head>
<body>
<th:block layout:fragment="content">
    <main>
        <h1>ğŸ¾ ë¶„ì„ ê²°ê³¼</h1>

        <div class="pet-info-header" th:if="${petImageUrl}">
            <img th:src="${petImageUrl}" alt="ë°˜ë ¤ë™ë¬¼ ì´ë¯¸ì§€" />
            <h2 th:text="${petName}"></h2>
            <p>ë‹˜ì„ ìœ„í•œ ë³´ê³ ì„œ</p>
        </div>

        <div class="result-block">
            <div id="visionReportOutput" class="report-content-display"></div>

            <form th:action="@{/flow/report}" method="post">
                <input type="hidden" name="petName" th:value="${petName}" />

                <label for="location">ì—¬í–‰ í¬ë§ ì§€ì—­</label>
                <div style="position: relative;">
                    <input type="text" name="location" id="location" placeholder="ì§€ì—­ í‚¤ì›Œë“œ ê²€ìƒ‰" required />
                </div>

                <label for="info">ì¶”ê°€ ìš”ì²­ ì‚¬í•­</label>
                <input type="text" name="info" id="info" />

                <input type="submit" value="ì—¬í–‰ì§€ ì¶”ì²œë°›ê¸°" />
            </form>
        </div>

        <div class="result-block" th:if="${error}">
            <h2>ì˜¤ë¥˜ ë°œìƒ</h2>
            <p th:text="${error}" style="color: red;"></p>
        </div>
    </main>
</th:block>

<th:block layout:fragment="script">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script th:src="@{/js/flow.js}"></script>

    <script th:inline="javascript">
        // 1. ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ 'visionReport' ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸ë¥¼ JavaScript ë³€ìˆ˜ì— í• ë‹¹
        const visionReportMarkdown = /*[[${visionReport}]]*/ '';

        // 2. marked.js ì˜µì…˜ ì„¤ì • (Marked.js v5.x ê¸°ì¤€)
        marked.setOptions({
            gfm: true,
            highlight: function(code, lang) {
                const grammar = Prism.languages[lang] || Prism.languages.markup;
                return Prism.highlight(code, grammar, lang);
            }
        });

        // 3. ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜
        const rawHtmlOutput = marked.parse(visionReportMarkdown);

        // 4. DOMPurifyë¥¼ ì‚¬ìš©í•˜ì—¬ ë³€í™˜ëœ HTML ì‚´ê· (Sanitize)
        const sanitizedHtml = DOMPurify.sanitize(rawHtmlOutput);

        // 5. ì‚´ê· ëœ HTMLì„ ì§€ì •ëœ divì— ì‚½ì…
        document.getElementById('visionReportOutput').innerHTML = sanitizedHtml;

        // 6. Prism.jsë¥¼ ì‹¤í–‰í•˜ì—¬ ë™ì ìœ¼ë¡œ ì¶”ê°€ëœ ì½”ë“œ ë¸”ë¡ì— í•˜ì´ë¼ì´íŒ… ì ìš©
        Prism.highlightAll();
    </script>
</th:block>
</body>
</html>