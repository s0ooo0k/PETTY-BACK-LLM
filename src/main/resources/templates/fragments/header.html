<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<body>
<header th:fragment="mainHeader">
    <!-- favicon -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <link
            rel="icon"
            type="image/png"
            href="./asset/favicon/favicon-96x96.png"
            sizes="96x96"
    />
    <link rel="icon" type="image/svg+xml" href="./asset/favicon/favicon.svg" />
    <link rel="shortcut icon" href="./asset/favicon/favicon.ico" />
    <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="./asset/favicon/apple-touch-icon.png"
    />
    <link rel="manifest" href="./asset/favicon/site.webmanifest" />
    <!-- og tag -->
    <meta
            property="og:title"
            content="PETTY - ë°˜ë ¤ë™ë¬¼ê³¼ í•¨ê»˜ ë– ë‚˜ëŠ” ì™„ë²½í•œ ì—¬í–‰"
    />
    <meta
            property="og:description"
            content="ìš°ë¦¬ ì•„ì´(ğŸ¶ğŸ±)ì™€ ì—¬í–‰ì„ ë– ë‚˜ê³  ì‹¶ë‹¤ë©´? PETTYê°€ ìµœì ì˜ ìˆ™ì†Œ, ê´€ê´‘ì§€, ìŒì‹ì ì„ ì¶”ì²œí•´ ì¤„ê²Œìš”! ğŸ¾"
    />
    <meta
            property="og:image"
            content="https://github.com/user-attachments/assets/42edc0f5-5e02-4709-97c5-3009ed6cdeb2"
    />

    <div class="menu-icon" onclick="toggleMenu(event)">
        <span></span>
        <span></span>
        <span></span>
    </div>
    <div class="logo-container">
        <img src="/assets/logo.png" alt="PETTY Logo">
        <h1><a th:href="@{/}">PETTY</a></h1>
    </div>

    <div class="account-btn-div" style="display: flex; gap: 15px;">

        <div id="loginMenu" style="display: none;">
            <a th:href="@{/login}">ë¡œê·¸ì¸</a>
            <a th:href="@{/join}">íšŒì›ê°€ì…</a>
        </div>

        <div id="userMenu" style="display: none;">
            <span id="userInfo" style="display: none;">
                <span id="username"></span>ë‹˜ <span id="role" style="display: none;"></span>
            </span>
            <a onclick="goToProfileEdit()">í”„ë¡œí•„</a>
            <a href="#" onclick="logout(event)">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </div>

    <script th:inline="javascript">
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ í•¨ìˆ˜ í˜¸ì¶œ
        document.addEventListener('DOMContentLoaded', async function() {
            await checkLoginStatus();
        });

        // ì‚¬ìš©ì ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        async function checkLoginStatus() {
            try {
                // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ API í˜¸ì¶œ. ì´ ìš”ì²­ì—ëŠ” HttpOnly ì¿ í‚¤(jwt)ê°€ ìë™ìœ¼ë¡œ í¬í•¨ë¨.
                const response = await fetch('/api/users/me');

                if (response.ok) {
                    // ì„±ê³µ: ë¡œê·¸ì¸ ìƒíƒœ í‘œì‹œ
                    const data = await response.json(); // ì‚¬ìš©ì ì •ë³´ë¥¼ JSONìœ¼ë¡œ íŒŒì‹±
                    document.getElementById('userMenu').style.display = 'inline'; // ì‚¬ìš©ì ë©”ë‰´ ë³´ì´ê¸°
                    document.getElementById('loginMenu').style.display = 'none'; // ë¡œê·¸ì¸/íšŒì›ê°€ì… ë©”ë‰´ ìˆ¨ê¸°ê¸°
                    document.getElementById('userInfo').style.display = 'block'; // ì‚¬ìš©ì ì •ë³´ ì˜ì—­ ë³´ì´ê¸°
                    document.getElementById('username').textContent = data.username; // ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ
                    document.getElementById('role').textContent = data.role; // ì‚¬ìš©ì ì—­í•  í‘œì‹œ
                } else if (response.status === 401) {
                    // ì•¡ì„¸ìŠ¤ í† í° ë§Œë£Œ (401 Unauthorized): ë¦¬í”„ë ˆì‹œ í† í°ìœ¼ë¡œ ê°±ì‹  ì‹œë„
                    console.log('ì•¡ì„¸ìŠ¤ í† í° ë§Œë£Œ, ë¦¬í”„ë ˆì‹œ í† í°ìœ¼ë¡œ ê°±ì‹  ì‹œë„');
                    try {
                        // í† í° ê°±ì‹  API í˜¸ì¶œ. ì´ ìš”ì²­ì—ë„ HttpOnly ì¿ í‚¤(refresh_token)ê°€ ìë™ìœ¼ë¡œ í¬í•¨ë¨.
                        const refreshResponse = await fetch('/api/auth/refresh', {
                            method: 'POST' // POST ìš”ì²­
                        });

                        if (refreshResponse.ok) {
                            console.log('í† í° ê°±ì‹  ì„±ê³µ! ì›ë˜ ìš”ì²­ ì¬ì‹œë„');
                            // í† í° ê°±ì‹  ì„±ê³µ â†’ checkLoginStatus()ë¥¼ ë‹¤ì‹œ í˜¸ì¶œí•˜ì—¬ UI ì—…ë°ì´íŠ¸
                            return await checkLoginStatus();
                        } else {
                            console.log('ë¦¬í”„ë ˆì‹œ í† í°ë„ ë§Œë£Œ, ë¡œê·¸ì¸ í•„ìš”');
                            showLoginMenu(); // ë¡œê·¸ì¸/íšŒì›ê°€ì… ë©”ë‰´ í‘œì‹œ
                        }
                    } catch (refreshError) {
                        console.error('í† í° ê°±ì‹  ì‹¤íŒ¨:', refreshError);
                        showLoginMenu(); // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¡œê·¸ì¸/íšŒì›ê°€ì… ë©”ë‰´ í‘œì‹œ
                    }
                } else {
                    // 401 ì´ì™¸ì˜ ë‹¤ë¥¸ ì—ëŸ¬ ë°œìƒ ì‹œ
                    showLoginMenu(); // ë¡œê·¸ì¸/íšŒì›ê°€ì… ë©”ë‰´ í‘œì‹œ
                }
            } catch (error) {
                // ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ë“± ìš”ì²­ ìì²´ ì‹¤íŒ¨ ì‹œ
                console.error('ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
                showLoginMenu(); // ë¡œê·¸ì¸/íšŒì›ê°€ì… ë©”ë‰´ í‘œì‹œ
            }
        }

        // ë¡œê·¸ì¸/íšŒì›ê°€ì… ë©”ë‰´ë¥¼ í‘œì‹œí•˜ê³  ì‚¬ìš©ì ë©”ë‰´ë¥¼ ìˆ¨ê¸°ëŠ” í•¨ìˆ˜
        function showLoginMenu() {
            document.getElementById('userMenu').style.display = 'none';
            document.getElementById('loginMenu').style.display = 'inline';
            document.getElementById('userInfo').style.display = 'none';
        }

        // í”„ë¡œí•„ í¸ì§‘ í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
        function goToProfileEdit() {
            window.location.href = '/profile/edit'; // ë¸Œë¼ìš°ì €ê°€ HttpOnly ì¿ í‚¤ë¥¼ ìë™ìœ¼ë¡œ ë‹´ì•„ì„œ GET ìš”ì²­ì„ ë³´ëƒ„
        }

        // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
        async function logout(event) {
            event.preventDefault(); // <a> íƒœê·¸ì˜ ê¸°ë³¸ ë™ì‘(í˜ì´ì§€ ì´ë™) ë°©ì§€
            try {
                // ì„œë²„ì— ë¡œê·¸ì•„ì›ƒ ìš”ì²­. ì´ ìš”ì²­ì—ë„ HttpOnly ì¿ í‚¤ê°€ ìë™ìœ¼ë¡œ í¬í•¨ë¨.
                const response = await fetch('/logout', {
                    method: 'POST' // POST ìš”ì²­
                });
                if (response.ok) {
                    alert('ë¡œê·¸ì•„ì›ƒ ì„±ê³µ');
                    window.location.href = '/'; // ë¡œê·¸ì•„ì›ƒ ì„±ê³µ ì‹œ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
                } else {
                    alert('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨');
                    // í•„ìš”í•˜ë‹¤ë©´ ì—ëŸ¬ ë©”ì‹œì§€ ìƒì„¸í™”
                }
            } catch (error) {
                console.error('ë¡œê·¸ì•„ì›ƒ ì—ëŸ¬:', error);
                alert('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
    </script>
</header>
</body>
</html>