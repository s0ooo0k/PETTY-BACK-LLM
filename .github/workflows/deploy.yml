name: Deploy to Oracle Cloud

on:
  push:
    branches: [ main, feat/prod ]
  pull_request:
    branches: [ main ]
    types: [ closed ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: |
          set -e
          echo "ðŸ”¨ Gradle ë¹Œë“œë¥¼ ì‹œìž‘í•©ë‹ˆë‹¤..."
          ./gradlew build -x test
          echo "âœ… Gradle ë¹Œë“œ ì„±ê³µ!"

      - name: Create deployment package
        run: |
          mkdir -p deploy
          if ls build/libs/*.jar 1> /dev/null 2>&1; then
            cp build/libs/*.jar deploy/petty-app.jar
            echo "âœ… JAR íŒŒì¼ ë³µì‚¬ ì™„ë£Œ"
          else
            echo "âŒ JAR íŒŒì¼ì´ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë°°í¬ ì¤‘ë‹¨"
            exit 1
          fi

      - name: Deploy to Oracle Cloud
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            sudo systemctl stop petty-app || true
            if [ -f /home/ubuntu/petty-app/app/petty-app.jar ]; then
              cp /home/ubuntu/petty-app/app/petty-app.jar /home/ubuntu/petty-app/app/petty-app.jar.backup
            fi
            echo "ðŸ•’ ìƒˆ JAR íŒŒì¼ ë³µì‚¬ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘..."

      - name: Copy JAR file
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "deploy/petty-app.jar"
          target: "/home/ubuntu/petty-app/app/"
          strip_components: 1

      - name: Start application
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ì—…ë°ì´íŠ¸
            cat > /home/ubuntu/petty-app/.env << 'EOF'
            SPRING_PROFILES_ACTIVE=prod

            # Database
            DB_SUPABASE_URL=${{ secrets.DB_SUPABASE_URL }}
            DB_SUPABASE_USERNAME=${{ secrets.DB_SUPABASE_USERNAME }}
            DB_SUPABASE_PASSWORD=${{ secrets.DB_SUPABASE_PASSWORD }}
            DB_AIVEN_URL=${{ secrets.DB_AIVEN_URL }}
            DB_AIVEN_USERNAME=${{ secrets.DB_AIVEN_USERNAME }}
            DB_AIVEN_PASSWORD=${{ secrets.DB_AIVEN_PASSWORD }}

            # JWT
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_EXPIRATION_TIME=3600000

            # OAuth
            OAUTH_GITHUB_CLIENT_ID=${{ secrets.OAUTH_GITHUB_CLIENT_ID }}
            OAUTH_GITHUB_CLIENT_SECRET=${{ secrets.OAUTH_GITHUB_CLIENT_SECRET }}
            OAUTH_KAKAO_CLIENT_ID=${{ secrets.OAUTH_KAKAO_CLIENT_ID }}
            OAUTH_KAKAO_CLIENT_SECRET=${{ secrets.OAUTH_KAKAO_CLIENT_SECRET }}
            OAUTH_KAKAO_REDIRECT_URI=${{ secrets.OAUTH_KAKAO_REDIRECT_URI }}

            # Email
            EMAIL_USERNAME=${{ secrets.EMAIL_USERNAME }}
            EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}

            # AWS
            AWS_REGION=${{ secrets.AWS_REGION }}
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}

            # Supabase
            SUPABASE_URL=${{ secrets.SUPABASE_URL }}
            SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}
            SUPABASE_BUCKET=${{ secrets.SUPABASE_BUCKET }}

            # OpenAI
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}

            # Qdrant
            QDRANT_HOST=${{ secrets.QDRANT_HOST }}
            QDRANT_PORT=${{ secrets.QDRANT_PORT }}
            QDRANT_COLLECTION=${{ secrets.QDRANT_COLLECTION }}
            QDRANT_API_KEY=${{ secrets.QDRANT_API_KEY }}

            # Vision APIs
            GEMINI_VISION_URL=${{ secrets.GEMINI_VISION_URL }}
            GEMINI_VISION_KEY=${{ secrets.GEMINI_VISION_KEY }}
            TOGETHER_VISION_URL=${{ secrets.TOGETHER_VISION_URL }}
            TOGETHER_VISION_KEY=${{ secrets.TOGETHER_VISION_KEY }}

            # Chat APIs
            GEMINI_CHAT_URL=${{ secrets.GEMINI_CHAT_URL }}
            GEMINI_CHAT_KEY=${{ secrets.GEMINI_CHAT_KEY }}
            TOGETHER_CHAT_MODEL=${{ secrets.TOGETHER_CHAT_MODEL }}
            TOGETHER_CHAT_URL=${{ secrets.TOGETHER_CHAT_URL }}
            TOGETHER_CHAT_KEY=${{ secrets.TOGETHER_CHAT_KEY }}

            # Tour API
            TOUR_API_BASE_URL=${{ secrets.TOUR_API_BASE_URL }}
            TOUR_API_SERVICE_KEY=${{ secrets.TOUR_API_SERVICE_KEY }}
            TOUR_API_MOBILE_OS=${{ secrets.TOUR_API_MOBILE_OS }}
            TOUR_API_MOBILE_APP=${{ secrets.TOUR_API_MOBILE_APP }}
            TOUR_API_TYPE=${{ secrets.TOUR_API_TYPE }}
            EOF

            chmod 600 /home/ubuntu/petty-app/.env

            # ì„œë¹„ìŠ¤ ì‹¤í–‰
            sudo systemctl start petty-app
            sleep 60

            # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
            if ! sudo systemctl is-active --quiet petty-app; then
              echo "âŒ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‹œìž‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              sudo systemctl status petty-app --no-pager
              sudo journalctl -u petty-app -n 20 --no-pager
              exit 1
            fi

            echo "âœ… ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
